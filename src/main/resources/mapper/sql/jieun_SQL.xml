<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="jieun">

<!-- 단골 가맹점 리스트 
	<select id="selectMyBusinessList" parameterType="hashmap" resultType="hashmap">
        <![CDATA[
        	SELECT 
		    S.userID,
		    B.businessName,
		    B.businessAddress,
		    B.businessPhoto,
		    COUNT(IF(S.couponNum IS NULL, 1, NULL)) stampCount,
		    COUNT(*) totalStampCount
		FROM
		    stamplist S,
		    business B
		WHERE
		    S.businessId = B.businessId
		AND
			S.userID = #{USERID}
		GROUP BY S.businessId
		UNION
		SELECT 
		    M.userID, 
		    B.businessName, 
		    B.businessAddress,
		    B.businessPhoto,
		    @stampCount := 0 stampCount,
		    @totalStampCount := 0 totalStampCount
		FROM
		    membership M,
		    business B
		WHERE
		    M.userID = #{USERID}
		        AND M.businessId = B.businessId
		        AND M.businessId NOT IN (SELECT 
		            S.businessId
		        FROM
		            stamplist S
		        WHERE
		            S.businessId = B.businessId
		                AND S.userID  =#{USERID}
		        GROUP BY S.businessId)
        ]]>
    </select>
   --> 
    
    <select id="selectMyBusinessList" parameterType="hashmap" resultType="hashmap">
        <![CDATA[
       SELECT 
		    B.businessId,
		    B.businessName,
		    B.businessAddress,
		    P.photoName,
		    COUNT(IF(S.couponNum IS NULL, 1, NULL)) stampCount,
		    COUNT(*) totalStampCount
		FROM
		    stamplist S
		    inner join business B on S.businessId = B.businessId
            inner join photo P on S.businessId = P.businessId
		WHERE
			S.userID = #{USERID}
		AND
			P.seq=1
		GROUP BY S.businessId
		UNION
		SELECT 
		    B.businessId, 
		    B.businessName, 
		    B.businessAddress,
		    P.photoName,
		    @stampCount := 0 stampCount,
		    @totalStampCount := 0 totalStampCount
		FROM
		    membership M,
		    business B,
		    photo P
		WHERE
		    M.userID = #{USERID}
		AND M.businessId = B.businessId
		AND M.businessID = P.businessId        
		AND M.businessId NOT IN (SELECT 
		            S.businessId
		        FROM
		            stamplist S
		        WHERE
		            S.businessId = B.businessId
		                AND S.userID  =#{USERID}
		        GROUP BY S.businessId)
		group by B.businessId
        ]]>
    </select>
    
    <select id="selectMyCoupon" parameterType="hashmap" resultType="hashmap">
        <![CDATA[
        	select a.*, c.couponName 
			from couponlist a, stamplist b, coupon c
			where a.couponNum = b.couponNum
			and a.businessId = c.businessId
			and a.couponCode = c.couponCode
			and b.userId=#{USERID}
			group by b.couponNum;	
        ]]>
    </select>
    
    
    
    <select id="selectCheckMembership" parameterType="hashmap" resultType="hashmap">
        <![CDATA[
        	SELECT
     			*
    		FROM
    			membership		
        ]]>
    </select>
    
     <select id="selectCheckMyMembership" parameterType="hashmap" resultType="String">
        <![CDATA[
        	SELECT
     			userId
    		FROM
    			membership
    		WHERE
    			userId = #{userId}
    		AND
    			businessId = #{businessId}
        ]]>
    </select>
    
    <insert id="insertMyBusiness" parameterType="hashmap">
    	<![CDATA[
    		INSERT
    			INTO membership
    		VALUES
    			( #{userId} , #{businessId} )
    	]]>
    </insert>
    
    <delete id="deleteMyBusiness" parameterType="hashmap">
    	<![CDATA[
    		DELETE FROM
    			membership
    		WHERE
    			userID = #{USERID}
			AND
				businessID = #{BUSINESSID}
    	]]>
    </delete>
</mapper>

